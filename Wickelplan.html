<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wickelplan (Werkstatt)</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#f6f7f9;
      --text:#111;
      --muted:#666;
      --border:#d9dde3;
      --accent:#0b5fff;
      --accent2:#0a4ed1;
      --ok:#0a7a2f;
      --warn:#b45309;
      --err:#b42318;
      --shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:var(--bg);
    }
    header{
      padding:16px 14px 10px 14px;
      border-bottom:1px solid var(--border);
      position:sticky; top:0; background:rgba(255,255,255,.92); backdrop-filter: blur(6px);
      z-index:10;
    }
    header h1{ margin:0; font-size:18px; font-weight:800; }
    header p{ margin:6px 0 0 0; font-size:13px; color:var(--muted); }

    main{ max-width:1020px; margin:0 auto; padding:14px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      box-shadow: var(--shadow);
    }
    .card h2{ margin:0 0 10px 0; font-size:15px; }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size:12px; color:var(--muted); }
    .field input, .field select, .field textarea{
      padding:10px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      font-size:14px;
      outline:none;
    }
    .field textarea{ min-height:78px; resize:vertical; }
    .field input:focus, .field select:focus, .field textarea:focus{
      border-color: rgba(11,95,255,.45);
      box-shadow: 0 0 0 3px rgba(11,95,255,.10);
    }
    .span2{ grid-column: 1 / -1; }

    .btnrow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    button{
      border:0;
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      cursor:pointer;
      background:#fff;
      border:1px solid var(--border);
    }
    button:hover{ border-color:#c3c9d2; }
    .btn-primary{ background:var(--accent); border-color:var(--accent); color:#fff; }
    .btn-primary:hover{ background:var(--accent2); border-color:var(--accent2); }
    .btn-danger{ border-color:#f1b4b4; color:var(--err); }
    .btn-danger:hover{ border-color:#e9a0a0; }
    .btn-ghost{ background:#fff; }

    .status{ margin-top:10px; font-size:13px; color:var(--muted); }
    .status b{ color:var(--text); }

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:12px;
      margin-left:6px;
    }
    .pill.ok{ border-color: rgba(10,122,47,.35); color:var(--ok); }
    .pill.warn{ border-color: rgba(180,83,9,.35); color:var(--warn); }
    .pill.err{ border-color: rgba(180,35,24,.35); color:var(--err); }

    .muted{ color:var(--muted); }

    .tablewrap{
      overflow:auto;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
    }
    table{
      border-collapse:collapse;
      width:100%;
      min-width:680px;
      font-size:13px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      white-space:nowrap;
      vertical-align:top;
    }
    th{
      position:sticky;
      top:0;
      background:#fff;
      z-index:1;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.2px;
    }
    tr:last-child td{ border-bottom:0; }

    .box{
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      padding:10px;
    }
    .box h3{
      margin:0 0 6px 0;
      font-size:13px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .box pre{
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      line-height:1.35;
    }

    .errbox{
      display:none;
      border:1px solid rgba(180,35,24,.35);
      background: rgba(180,35,24,.06);
      border-radius:12px;
      padding:10px;
      margin-top:10px;
    }
    .errbox h3{
      margin:0 0 6px 0;
      font-size:13px;
      color:var(--err);
      font-weight:800;
    }
    .errbox pre{
      margin:0;
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      color:#222;
    }

    details{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    details + details{ margin-top:10px; }
    summary{
      list-style:none;
      cursor:pointer;
      padding:12px;
      background:linear-gradient(180deg,#ffffff,#fbfbfd);
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:800;
    }
    summary::-webkit-details-marker{ display:none; }
    .sum-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .chev{
      width:22px; height:22px;
      border-radius:999px;
      border:1px solid var(--border);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      color:var(--muted);
      flex:0 0 auto;
    }
    details[open] .chev{ transform: rotate(90deg); }
    .sum-title{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sum-hint{ font-size:12px; color:var(--muted); font-weight:600; white-space:nowrap; }
    .panel{ padding:12px; background:#fff; }

    .jsonArea{
      width:100%;
      min-height:120px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
    }

    .nameplate{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .nameplate .field input{ font-size:13px; }

    .tiny{ font-size:12px; color:var(--muted); margin-top:6px; }

    /* optional: Eingabe am kleinen Handy 1-spaltig */
    @media (max-width: 520px){
      .form, .nameplate{ grid-template-columns: 1fr; }
      .span2{ grid-column: auto; }
    }

    /* Print / PDF */
    @media print{
      header, .no-print { display:none !important; }
      body{ background:#fff; }
      main{ max-width:none; padding:0; }
      .card{ border:0; background:#fff; padding:0; box-shadow:none; }
      details{ border:0; }
      summary{ border:0; padding:0 0 8px 0; background:#fff; }
      .panel{ padding:0; }
      .tablewrap{ border:0; }
      th{ position:static; }
      table{ min-width:0; }
      .box{ border:0; padding:0; }
      .errbox{ display:none !important; }
    }
  </style>
</head>

<body>
  <header>
    <h1>Wickelplan – Werkstatt</h1>
    <p>
      Mit Eingabedaten (Draht/Windungen/Notizen), Typenschild-Block, JSON Export/Import, Fehleranzeige,
      plus einklappbaren Tabellen.
    </p>
  </header>

  <main>
    <div class="grid">
      <!-- Eingabe -->
      <section class="card no-print">
        <h2>Eingabe</h2>

        <div class="form">
          <div class="field">
            <label for="z">Nuten Z</label>
            <input id="z" type="number" min="6" step="1" placeholder="z.B. 36">
          </div>

          <div class="field">
            <label for="poles">Polzahl</label>
            <select id="poles">
              <option value="2">2-pol</option>
              <option value="4" selected>4-pol</option>
              <option value="6">6-pol</option>
              <option value="8">8-pol</option>
              <option value="10">10-pol</option>
              <option value="12">12-pol</option>
            </select>
          </div>

          <div class="field">
            <label for="layers">Schichten (klassisch)</label>
            <select id="layers">
              <option value="1">einschicht</option>
              <option value="2" selected>zweischicht</option>
            </select>
          </div>

          <div class="field">
            <label for="y">Wickelschritt y</label>
            <input id="y" type="number" min="1" step="1" placeholder="z.B. 9">
          </div>

          <div class="field">
            <label for="conn">Schaltung</label>
            <select id="conn">
              <option value="stern" selected>Stern (Y)</option>
              <option value="dreieck">Dreieck (Δ)</option>
            </select>
          </div>

          <div class="field">
            <label for="terminals">Klemmenbild</label>
            <select id="terminals">
              <option value="6" selected>6 Klemmen (U1/V1/W1/U2/V2/W2)</option>
              <option value="3">3 Klemmen (U/V/W)</option>
            </select>
          </div>

          <div class="field">
            <label for="layersPerSlot">Lagen pro Nut</label>
            <select id="layersPerSlot">
              <option value="2" selected>2 Lagen (unten/oben)</option>
              <option value="3">3 Lagen</option>
              <option value="4">4 Lagen</option>
              <option value="5">5 Lagen</option>
              <option value="6">6 Lagen</option>
            </select>
          </div>

          <div class="field">
            <label for="workMode">Arbeitsweise</label>
            <select id="workMode">
              <option value="slotwise" selected>Nutenweise (Nut für Nut)</option>
              <option value="lowerThenUpper">Gruppenweise (erst unten, dann oben)</option>
            </select>
          </div>

          <!-- Echte Werkstattdaten -->
          <div class="field">
            <label for="turns">Windungen pro Spule (N)</label>
            <input id="turns" type="number" min="1" step="1" placeholder="z.B. 38">
          </div>

          <div class="field">
            <label for="wire">Draht (z.B. 0,90mm oder 2×0,63mm)</label>
            <input id="wire" type="text" placeholder="z.B. 0,90mm">
          </div>

          <div class="field span2">
            <label for="notes">Notizen (Werkstatt)</label>
            <textarea id="notes" placeholder="z.B. Drehrichtung, Nutisolation, Bandage, Imprägnierung..."></textarea>
          </div>
        </div>

        <div class="btnrow">
          <button class="btn-ghost" id="btnDemo" type="button">Plausibles Beispiel laden</button>
          <button class="btn-primary" id="btnCalc" type="button">Plan anzeigen</button>
          <button class="btn-ghost" id="btnPrint" type="button">Drucken / PDF</button>
          <button class="btn-danger" id="btnClear" type="button">Reset</button>
        </div>

        <div class="status" id="status">
          Status: <b>bereit</b><span class="pill ok">OK</span>
        </div>
        <div id="messages" class="muted" style="margin-top:8px;"></div>

        <!-- Fehlerbox (ohne F12) -->
        <div id="fatalError" class="errbox">
          <h3>Fehler in der App</h3>
          <pre id="fatalErrorText">—</pre>
          <div class="tiny">Tipp: Screenshot machen und mir schicken.</div>
        </div>
      </section>

      <!-- Typenschild / Datenübersicht -->
      <section class="card">
        <h2>Typenschild / Motordaten (zum Abtippen)</h2>
        <div class="nameplate">
          <div class="field">
            <label for="np_manu">Hersteller</label>
            <input id="np_manu" type="text" placeholder="z.B. Siemens">
          </div>
          <div class="field">
            <label for="np_type">Typ / Baureihe</label>
            <input id="np_type" type="text" placeholder="z.B. 1LA7 ...">
          </div>

          <div class="field">
            <label for="np_serial">Seriennummer</label>
            <input id="np_serial" type="text" placeholder="z.B. SN ...">
          </div>
          <div class="field">
            <label for="np_year">Baujahr</label>
            <input id="np_year" type="text" placeholder="z.B. 2018">
          </div>

          <div class="field">
            <label for="np_power">Leistung (kW)</label>
            <input id="np_power" type="text" placeholder="z.B. 1,5 kW">
          </div>
          <div class="field">
            <label for="np_speed">Drehzahl (rpm)</label>
            <input id="np_speed" type="text" placeholder="z.B. 1420">
          </div>

          <div class="field">
            <label for="np_voltage">Spannung (V)</label>
            <input id="np_voltage" type="text" placeholder="z.B. 230/400">
          </div>
          <div class="field">
            <label for="np_current">Strom (A)</label>
            <input id="np_current" type="text" placeholder="z.B. 5,2/3,0">
          </div>

          <div class="field">
            <label for="np_freq">Frequenz (Hz)</label>
            <input id="np_freq" type="text" placeholder="z.B. 50">
          </div>
          <div class="field">
            <label for="np_cosphi">cos φ</label>
            <input id="np_cosphi" type="text" placeholder="z.B. 0,82">
          </div>

          <div class="field">
            <label for="np_eff">Wirkungsgrad (η)</label>
            <input id="np_eff" type="text" placeholder="z.B. IE2 82%">
          </div>
          <div class="field">
            <label for="np_ip">Schutzart (IP)</label>
            <input id="np_ip" type="text" placeholder="z.B. IP55">
          </div>

          <div class="field">
            <label for="np_ins">Isolationsklasse</label>
            <input id="np_ins" type="text" placeholder="z.B. F">
          </div>
          <div class="field">
            <label for="np_duty">Betriebsart</label>
            <input id="np_duty" type="text" placeholder="z.B. S1">
          </div>

          <div class="field">
            <label for="np_amb">Umgebung</label>
            <input id="np_amb" type="text" placeholder="z.B. 40°C">
          </div>
          <div class="field">
            <label for="np_mount">Bauform / Montage</label>
            <input id="np_mount" type="text" placeholder="z.B. B3 / IM B3">
          </div>

          <div class="field span2">
            <label for="np_more">Zusatz (Lager, Schaltbild, Normen, etc.)</label>
            <input id="np_more" type="text" placeholder="z.B. DE/ND Lager, Schaltbild Y/Δ, IEC...">
          </div>
        </div>

        <div class="tiny">
          Diese Felder sind genau dafür da, dass du beim echten Motor das Typenschild abtippst/fotografierst und alle relevanten Daten beisammen hast.
        </div>
      </section>

      <!-- JSON Export/Import -->
      <section class="card no-print">
        <h2>JSON Export / Import</h2>
        <div class="btnrow" style="margin-top:0;">
          <button class="btn-ghost" id="btnExportJson" type="button">JSON erzeugen</button>
          <button class="btn-ghost" id="btnCopyJson" type="button">JSON kopieren</button>
          <button class="btn-ghost" id="btnImportJson" type="button">JSON importieren</button>
        </div>
        <div class="tiny">Tipp: In der Werkstatt könnt ihr einen Motor als JSON speichern und später wieder laden.</div>
        <textarea id="jsonArea" class="jsonArea" placeholder="Hier erscheint der Export oder hier JSON zum Import einfügen..."></textarea>
      </section>

      <!-- Ausgabe / einklappbar -->
      <section class="card">
        <h2>Ausgabe (einklappbar)</h2>

        <details open>
          <summary>
            <div class="sum-left">
              <span class="chev">›</span>
              <span class="sum-title">Klemmenplan / Anschluss-Hinweise</span>
            </div>
            <span class="sum-hint">U/V/W – Stern/Dreieck</span>
          </summary>
          <div class="panel">
            <div class="box">
              <h3>Klemmen / Hinweis</h3>
              <pre id="terminalPlan" class="muted">Wird beim „Plan anzeigen“ erzeugt.</pre>
            </div>
            <div class="box" style="margin-top:10px;">
              <h3>Kopfblatt (für PDF)</h3>
              <pre id="headerSheet" class="muted">Wird beim „Plan anzeigen“ erzeugt.</pre>
            </div>
          </div>
        </details>

        <details open>
          <summary>
            <div class="sum-left">
              <span class="chev">›</span>
              <span class="sum-title">Tabelle A – Spulenliste (Nut → Nut)</span>
            </div>
            <span class="sum-hint">Spulenübersicht</span>
          </summary>
          <div class="panel">
            <div class="tablewrap">
              <table id="coilTable" aria-label="Spulenliste">
                <thead>
                  <tr>
                    <th>Spule Nr.</th>
                    <th>Lage</th>
                    <th>Startnut</th>
                    <th>Endnut</th>
                    <th>Phase</th>
                    <th>+/−</th>
                    <th>Gruppe</th>
                    <th>Windungen</th>
                    <th>Draht</th>
                  </tr>
                </thead>
                <tbody id="coilBody">
                  <tr><td colspan="9" class="muted">Noch kein Plan – „Plausibles Beispiel laden“ oder „Plan anzeigen“.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </details>

        <details>
          <summary>
            <div class="sum-left">
              <span class="chev">›</span>
              <span class="sum-title">Tabelle B – Nutenbelegung (oben / unten)</span>
            </div>
            <span class="sum-hint">Nutübersicht</span>
          </summary>
          <div class="panel">
            <div class="tablewrap">
              <table id="slotTable" aria-label="Nutenbelegung">
                <thead>
                  <tr>
                    <th>Nut</th>
                    <th>oben</th>
                    <th>unten</th>
                  </tr>
                </thead>
                <tbody id="slotBody">
                  <tr><td colspan="3" class="muted">Wird automatisch aus der Spulenliste erzeugt.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </details>

        <details open>
          <summary>
            <div class="sum-left">
              <span class="chev">›</span>
              <span class="sum-title">Tabelle C – Nut-Füllplan (Lagen)</span>
            </div>
            <span class="sum-hint">für „hineinträufeln“</span>
          </summary>
          <div class="panel">
            <div class="tablewrap">
              <table id="fillTable" aria-label="Nut-Füllplan">
                <thead id="fillHead">
                  <tr><th class="muted">Noch kein Plan</th></tr>
                </thead>
                <tbody id="fillBody">
                  <tr><td class="muted">Wird beim „Plan anzeigen“ erzeugt.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </details>

        <details open>
          <summary>
            <div class="sum-left">
              <span class="chev">›</span>
              <span class="sum-title">Tabelle D – Einlegefolge / Arbeitsfolge</span>
            </div>
            <span class="sum-hint">Rezept-Liste</span>
          </summary>
          <div class="panel">
            <div class="box">
              <h3>Einlegefolge</h3>
              <pre id="sequence" class="muted">Wird beim „Plan anzeigen“ erzeugt.</pre>
            </div>
          </div>
        </details>

        <p class="muted" style="margin:10px 0 0 0; font-size:12px;">
          Tipp: Für PDF einfach „Drucken / PDF“ klicken und im Browser „Als PDF speichern“ wählen.
        </p>
      </section>
    </div>
  </main>

  <script>
    // -----------------------------
    // Fehleranzeige (ohne F12)
    // -----------------------------
    function showFatalError(err) {
      const box = document.getElementById("fatalError");
      const txt = document.getElementById("fatalErrorText");
      if (!box || !txt) return;
      box.style.display = "block";
      txt.textContent = String(err && err.stack ? err.stack : err);
    }

    window.addEventListener("error", (e) => {
      showFatalError(e.error || e.message || "Unbekannter Fehler");
    });

    window.addEventListener("unhandledrejection", (e) => {
      showFatalError(e.reason || "Unhandled Promise Rejection");
    });

    // -----------------------------
    // Helper
    // -----------------------------
    const $ = (id) => document.getElementById(id);

    function setStatus(text, type="ok") {
      let pill = '<span class="pill ok">OK</span>';
      if (type === "warn") pill = '<span class="pill warn">Hinweis</span>';
      if (type === "error") pill = '<span class="pill err">Fehler</span>';
      $("status").innerHTML = `Status: <b>${text}</b>${pill}`;
    }

    function renderMessages(check) {
      const el = $("messages");
      if (!el) return;

      const warns = (check && check.warns) ? check.warns : [];
      const errors = (check && check.errors) ? check.errors : [];

      if (warns.length === 0 && errors.length === 0) {
        el.innerHTML = "";
        return;
      }

      const items = [];
      for (const w of warns) items.push(`<li>${w}</li>`);
      for (const e of errors) items.push(`<li>${e}</li>`);

      el.innerHTML = `<ul style="margin:6px 0 0 18px; padding:0;">${items.join("")}</ul>`;
    }

    function normalizeNut(n, z) {
      let x = n % z;
      if (x === 0) x = z;
      if (x < 0) x += z;
      return x;
    }

    function safeInt(v, fallback=null) {
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : fallback;
    }

    function safeStr(v) {
      return (v ?? "").toString().trim();
    }

    // -----------------------------
    // Plausibilitätscheck
    // -----------------------------
    function plausibilityCheck(input) {
      const issues = { errors: [], warns: [] };
      const { z, poles, layers, y } = input;

      if (!Number.isInteger(z) || z < 6) issues.errors.push("Nuten Z ist ungültig (mind. 6).");
      if (!Number.isInteger(poles) || poles < 2) issues.errors.push("Polzahl ist ungültig.");
      if (!Number.isInteger(y) || y < 1) issues.errors.push("Wickelschritt y ist ungültig (mind. 1).");
      if (![1,2].includes(layers)) issues.errors.push("Schichten muss 1 oder 2 sein.");
      if (issues.errors.length) return issues;

      if (y >= z) issues.errors.push("y darf nicht >= Z sein.");
      if (y > Math.floor(z/2)) issues.warns.push("y ist größer als Z/2 (ungewöhnlich).");

      const fullPitch = z / poles;
      const diff = Math.abs(y - fullPitch);
      if (diff > 3) issues.warns.push(`Wickelschritt wirkt unplausibel: y=${y}, Vollschritt≈${fullPitch.toFixed(1)}.`);

      if (layers === 2 && z < 12) issues.warns.push("Zweischicht mit sehr kleiner Nutenzahl ist ungewöhnlich.");
      if (z % 3 !== 0) issues.warns.push("Z ist nicht durch 3 teilbar (bei 3-phasig oft unüblich).");

      return issues;
    }

    // -----------------------------
    // DEMO
    // -----------------------------
    function buildDemoInput() {
      return {
        z: 36,
        poles: 4,
        layers: 2,
        y: 9,
        conn: "stern",
        terminals: 6,
        layersPerSlot: 2,
        workMode: "slotwise",
        turns: 38,
        wire: "0,90mm",
        notes: "Blick Antriebsseite, Nut 1 oben, Uhrzeigersinn. Nutisolation prüfen."
      };
    }

    function buildDemoNameplate() {
      return {
        np_manu: "Beispiel",
        np_type: "IEC Motor",
        np_serial: "—",
        np_year: "—",
        np_power: "1,5",
        np_speed: "1420",
        np_voltage: "230/400",
        np_current: "5,2/3,0",
        np_freq: "50",
        np_cosphi: "0,82",
        np_eff: "IE2",
        np_ip: "IP55",
        np_ins: "F",
        np_duty: "S1",
        np_amb: "40°C",
        np_mount: "B3 / IM B3",
        np_more: "—"
      };
    }

    function buildDemoCoils(input) {
      const { z, y } = input;
      const phases = ["U", "V", "W"];
      const coils = [];
      const count = Math.min(z, 24);
      for (let i = 1; i <= count; i++) {
        const startNut = i;
        const endNut = normalizeNut(i + y, z);
        coils.push({
          nr: i,
          lage: "oben→unten",
          startNut,
          endNut,
          phase: phases[(i - 1) % 3],
          sign: (Math.floor((i - 1) / 6) % 2 === 0) ? "+" : "-",
          gruppe: Math.floor((i - 1) / 6) + 1
        });
      }
      return coils;
    }

    function computeWindingPlan(input) {
      // TODO: echte Wickel-Logik später
      return { coils: buildDemoCoils(input) };
    }

    // -----------------------------
    // Tabellen A/B
    // -----------------------------
    function renderCoilTable(coils, turns, wire) {
      const body = $("coilBody");
      body.innerHTML = "";
      if (!coils || coils.length === 0) {
        body.innerHTML = `<tr><td colspan="9" class="muted">Keine Spulen vorhanden.</td></tr>`;
        return;
      }
      for (const c of coils) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.nr}</td>
          <td>${c.lage}</td>
          <td>${c.startNut}</td>
          <td>${c.endNut}</td>
          <td>${c.phase}</td>
          <td>${c.sign}</td>
          <td>${c.gruppe}</td>
          <td>${turns || '<span class="muted">—</span>'}</td>
          <td>${wire || '<span class="muted">—</span>'}</td>
        `;
        body.appendChild(tr);
      }
    }

    function buildSlotsFromCoils(z, coils) {
      const slots = Array.from({ length: z + 1 }, () => ({ oben: "", unten: "" }));
      for (const c of coils) {
        const obenText = `${c.sign}${c.phase}`;
        const untenText = `${c.sign}${c.phase}`;
        const s = normalizeNut(c.startNut, z);
        const e = normalizeNut(c.endNut, z);
        slots[s].oben = slots[s].oben ? `${slots[s].oben}, ${obenText}` : obenText;
        slots[e].unten = slots[e].unten ? `${slots[e].unten}, ${untenText}` : untenText;
      }
      return slots;
    }

    function renderSlotTable(z, slots) {
      const body = $("slotBody");
      body.innerHTML = "";
      for (let nut = 1; nut <= z; nut++) {
        const tr = document.createElement("tr");
        const oben = slots[nut]?.oben || "";
        const unten = slots[nut]?.unten || "";
        tr.innerHTML = `
          <td>${nut}</td>
          <td>${oben || '<span class="muted">—</span>'}</td>
          <td>${unten || '<span class="muted">—</span>'}</td>
        `;
        body.appendChild(tr);
      }
    }

    // -----------------------------
    // Nut-Füllplan + Einlegefolge
    // -----------------------------
    function splitLayers(totalLayers) {
      const topCount = Math.ceil(totalLayers / 2);
      const bottomCount = totalLayers - topCount;
      return { topCount, bottomCount };
    }

    function makeEmptyFillPlan(z, totalLayers) {
      const { topCount, bottomCount } = splitLayers(totalLayers);
      const plan = Array.from({ length: z + 1 }, () => ({
        bottom: Array.from({ length: bottomCount }, () => ""),
        top: Array.from({ length: topCount }, () => "")
      }));
      return { plan, topCount, bottomCount };
    }

    function formatConductor(c, sideLabel) {
      return `${c.sign}${c.phase}#${c.nr}${sideLabel}`;
    }

    function placeInFirstFree(arr, text) {
      for (let i = 0; i < arr.length; i++) {
        if (!arr[i]) { arr[i] = text; return; }
      }
      if (arr.length === 0) return;
      arr[arr.length - 1] = arr[arr.length - 1] ? `${arr[arr.length - 1]}, ${text}` : text;
    }

    function buildFillPlanFromCoils(z, coils, totalLayers) {
      const { plan, topCount, bottomCount } = makeEmptyFillPlan(z, totalLayers);

      for (const c of coils) {
        const s = normalizeNut(c.startNut, z);
        const e = normalizeNut(c.endNut, z);
        const tA = formatConductor(c, "A");
        const tB = formatConductor(c, "B");

        if (topCount > 0) placeInFirstFree(plan[s].top, tA);
        if (bottomCount > 0) placeInFirstFree(plan[e].bottom, tB);
        else if (topCount > 0) placeInFirstFree(plan[e].top, tB);
      }

      return { plan, topCount, bottomCount };
    }

    function renderFillPlanTable(z, fill) {
      const head = $("fillHead");
      const body = $("fillBody");
      head.innerHTML = "";
      body.innerHTML = "";

      const { topCount, bottomCount, plan } = fill;

      const trh = document.createElement("tr");
      trh.innerHTML =
        `<th>Nut</th>` +
        Array.from({length: bottomCount}, (_,i)=>`<th>unten L${i+1}</th>`).join("") +
        Array.from({length: topCount}, (_,i)=>`<th>oben L${i+1}</th>`).join("");
      head.appendChild(trh);

      for (let slot = 1; slot <= z; slot++) {
        const tr = document.createElement("tr");
        let html = `<td>${slot}</td>`;
        for (let i = 0; i < bottomCount; i++) {
          const v = plan[slot].bottom[i] || "";
          html += `<td>${v || '<span class="muted">—</span>'}</td>`;
        }
        for (let i = 0; i < topCount; i++) {
          const v = plan[slot].top[i] || "";
          html += `<td>${v || '<span class="muted">—</span>'}</td>`;
        }
        tr.innerHTML = html;
        body.appendChild(tr);
      }

      const min = 240 + (bottomCount + topCount) * 180;
      $("fillTable").style.minWidth = `${Math.max(680, min)}px`;
    }

    function buildInsertSequence(z, fill, workMode) {
      const { topCount, bottomCount, plan } = fill;
      const steps = [];

      const pushStep = (slot, side, layerIndex, content) => {
        steps.push(`• Nut ${slot} ${side} L${layerIndex+1}: ${content}`);
      };

      if (workMode === "lowerThenUpper") {
        for (let li = 0; li < bottomCount; li++) {
          for (let slot = 1; slot <= z; slot++) {
            const c = plan[slot].bottom[li];
            if (c) pushStep(slot, "unten", li, c);
          }
        }
        for (let li = 0; li < topCount; li++) {
          for (let slot = 1; slot <= z; slot++) {
            const c = plan[slot].top[li];
            if (c) pushStep(slot, "oben", li, c);
          }
        }
      } else {
        for (let slot = 1; slot <= z; slot++) {
          for (let li = 0; li < bottomCount; li++) {
            const c = plan[slot].bottom[li];
            if (c) pushStep(slot, "unten", li, c);
          }
          for (let li = 0; li < topCount; li++) {
            const c = plan[slot].top[li];
            if (c) pushStep(slot, "oben", li, c);
          }
        }
      }

      if (steps.length === 0) return "Keine Einlegefolge (noch keine Leiter im Plan).";

      steps.push("");
      steps.push("— Abschluss (Werkstatt) —");
      steps.push("• Nutkeile setzen / sichern");
      steps.push("• Bandagieren / Verschnüren (falls üblich)");
      steps.push("• Träufeln/Imprägnieren + Aushärtung (falls üblich)");
      steps.push("• Isolationsmessung / Widerstände je Phase prüfen");

      return steps.join("\n");
    }

    // -----------------------------
    // Klemmenplan + Kopfblatt
    // -----------------------------
    function buildTerminalPlanText(input) {
      const conn = input.conn;
      const terminals = input.terminals;

      if (terminals === 3) {
        return [
          `Klemmenbild: 3 Klemmen (U/V/W)`,
          `Schaltung: ${conn === "stern" ? "Stern (intern)" : "Dreieck (intern)"}`,
          ``,
          `Hinweis: Bei 3 Klemmen ist die Verschaltung meist intern fix (kein Umbrücken).`
        ].join("\n");
      }

      if (conn === "stern") {
        return [
          `Klemmenbild: 6 Klemmen (U1/V1/W1/U2/V2/W2)`,
          `Schaltung: Stern (Y)`,
          ``,
          `Brücken: U2 + V2 + W2 zusammen (Sternpunkt)`,
          `Einspeisung: L1->U1, L2->V1, L3->W1`
        ].join("\n");
      }

      return [
        `Klemmenbild: 6 Klemmen (U1/V1/W1/U2/V2/W2)`,
        `Schaltung: Dreieck (Δ)`,
        ``,
        `Brücken: U1–W2, V1–U2, W1–V2`,
        `Einspeisung: an die drei Brückenpunkte (L1/L2/L3)`
      ].join("\n");
    }

    function buildHeaderSheetText(input) {
      const turns = safeStr($("turns").value);
      const wire = safeStr($("wire").value);
      const notes = safeStr($("notes").value);

      const np = readNameplate();

      return [
        `— Kopfblatt (Werkstatt) —`,
        `Z=${input.z} | ${input.poles}-pol | Schichten=${input.layers} | y=${input.y} | Schaltung=${input.conn} | Klemmen=${input.terminals}`,
        `Lagen pro Nut=${input.layersPerSlot} | Arbeitsweise=${input.workMode}`,
        ``,
        `Wickeldaten: Windungen/Spule=${turns || "—"} | Draht=${wire || "—"}`,
        ``,
        `Typenschild (falls vorhanden):`,
        `Hersteller=${np.np_manu || "—"} | Typ=${np.np_type || "—"} | SN=${np.np_serial || "—"} | Bj=${np.np_year || "—"}`,
        `kW=${np.np_power || "—"} | rpm=${np.np_speed || "—"} | V=${np.np_voltage || "—"} | A=${np.np_current || "—"} | Hz=${np.np_freq || "—"}`,
        `cosφ=${np.np_cosphi || "—"} | η=${np.np_eff || "—"} | IP=${np.np_ip || "—"} | Isokl.=${np.np_ins || "—"} | S=${np.np_duty || "—"}`,
        `Umgebung=${np.np_amb || "—"} | Bauform=${np.np_mount || "—"}`,
        `Zusatz=${np.np_more || "—"}`,
        ``,
        `Notizen:`,
        `${notes || "—"}`
      ].join("\n");
    }

    // -----------------------------
    // Typenschild lesen/schreiben
    // -----------------------------
    const NAMEPLATE_IDS = [
      "np_manu","np_type","np_serial","np_year","np_power","np_speed","np_voltage","np_current",
      "np_freq","np_cosphi","np_eff","np_ip","np_ins","np_duty","np_amb","np_mount","np_more"
    ];

    function readNameplate() {
      const out = {};
      for (const id of NAMEPLATE_IDS) out[id] = safeStr($(id).value);
      return out;
    }

    function applyNameplate(npObj) {
      for (const id of NAMEPLATE_IDS) {
        if ($(id)) $(id).value = (npObj && (id in npObj)) ? (npObj[id] ?? "") : "";
      }
    }

    // -----------------------------
    // Eingabe lesen
    // -----------------------------
    function readInput() {
      const z = safeInt($("z").value, null);
      const poles = safeInt($("poles").value, 4);
      const layers = safeInt($("layers").value, 2);
      const y = safeInt($("y").value, null);
      const conn = $("conn").value;

      const terminals = safeInt($("terminals").value, 6);
      const layersPerSlot = safeInt($("layersPerSlot").value, 2);
      const workMode = $("workMode").value;

      const turns = safeInt($("turns").value, null);
      const wire = safeStr($("wire").value);
      const notes = safeStr($("notes").value);

      const problems = [];
      if (!z || z < 6) problems.push("Z (Nuten) fehlt oder ist zu klein.");
      if (!y || y < 1) problems.push("Wickelschritt y fehlt oder ist ungültig.");
      if (![1,2].includes(layers)) problems.push("Schichten muss 1 oder 2 sein.");
      if (!layersPerSlot || layersPerSlot < 2) problems.push("Lagen pro Nut muss mind. 2 sein.");

      return {
        input: { z, poles, layers, y, conn, terminals, layersPerSlot, workMode, turns, wire, notes },
        problems
      };
    }

    // -----------------------------
    // Demo / Reset
    // -----------------------------
    function applyDemo() {
      const d = buildDemoInput();
      $("z").value = d.z;
      $("poles").value = String(d.poles);
      $("layers").value = String(d.layers);
      $("y").value = d.y;
      $("conn").value = d.conn;
      $("terminals").value = String(d.terminals);
      $("layersPerSlot").value = String(d.layersPerSlot);
      $("workMode").value = d.workMode;

      $("turns").value = d.turns;
      $("wire").value = d.wire;
      $("notes").value = d.notes;

      applyNameplate(buildDemoNameplate());

      setStatus("Plausibles Beispiel geladen", "ok");
      renderMessages({ warns: [], errors: [] });
    }

    function clearAll() {
      $("z").value = "";
      $("y").value = "";
      $("poles").value = "4";
      $("layers").value = "2";
      $("conn").value = "stern";
      $("terminals").value = "6";
      $("layersPerSlot").value = "2";
      $("workMode").value = "slotwise";

      $("turns").value = "";
      $("wire").value = "";
      $("notes").value = "";

      applyNameplate({});

      $("coilBody").innerHTML = `<tr><td colspan="9" class="muted">Noch kein Plan – „Plausibles Beispiel laden“ oder „Plan anzeigen“.</td></tr>`;
      $("slotBody").innerHTML = `<tr><td colspan="3" class="muted">Wird automatisch aus der Spulenliste erzeugt.</td></tr>`;
      $("fillHead").innerHTML = `<tr><th class="muted">Noch kein Plan</th></tr>`;
      $("fillBody").innerHTML = `<tr><td class="muted">Wird beim „Plan anzeigen“ erzeugt.</td></tr>`;
      $("sequence").textContent = "Wird beim „Plan anzeigen“ erzeugt.";
      $("terminalPlan").textContent = "Wird beim „Plan anzeigen“ erzeugt.";
      $("headerSheet").textContent = "Wird beim „Plan anzeigen“ erzeugt.";

      $("messages").innerHTML = "";
      setStatus("bereit", "ok");
    }

    // -----------------------------
    // JSON Export/Import
    // -----------------------------
    function buildStateObject() {
      const { input } = readInput();
      const np = readNameplate();
      return {
        version: 1,
        timestamp: new Date().toISOString(),
        input: {
          z: input.z, poles: input.poles, layers: input.layers, y: input.y,
          conn: input.conn, terminals: input.terminals,
          layersPerSlot: input.layersPerSlot, workMode: input.workMode,
          turns: input.turns, wire: input.wire, notes: input.notes
        },
        nameplate: np
      };
    }

    function applyStateObject(state) {
      if (!state || !state.input) throw new Error("JSON hat kein Feld 'input'.");
      const i = state.input;

      $("z").value = i.z ?? "";
      $("poles").value = String(i.poles ?? "4");
      $("layers").value = String(i.layers ?? "2");
      $("y").value = i.y ?? "";
      $("conn").value = i.conn ?? "stern";

      $("terminals").value = String(i.terminals ?? "6");
      $("layersPerSlot").value = String(i.layersPerSlot ?? "2");
      $("workMode").value = i.workMode ?? "slotwise";

      $("turns").value = i.turns ?? "";
      $("wire").value = i.wire ?? "";
      $("notes").value = i.notes ?? "";

      applyNameplate(state.nameplate || {});
    }

    function exportJsonToArea() {
      const state = buildStateObject();
      $("jsonArea").value = JSON.stringify(state, null, 2);
      setStatus("JSON erzeugt", "ok");
    }

    async function copyJson() {
      const txt = $("jsonArea").value.trim();
      if (!txt) { setStatus("Kein JSON zum Kopieren vorhanden", "warn"); return; }
      try {
        await navigator.clipboard.writeText(txt);
        setStatus("JSON kopiert", "ok");
      } catch (e) {
        // Fallback: markieren
        $("jsonArea").focus();
        $("jsonArea").select();
        setStatus("Kopieren blockiert – Text ist markiert (CMD+C)", "warn");
      }
    }

    function importJsonFromArea() {
      const txt = $("jsonArea").value.trim();
      if (!txt) { setStatus("Bitte JSON in das Feld einfügen", "warn"); return; }
      try {
        const obj = JSON.parse(txt);
        applyStateObject(obj);
        setStatus("JSON importiert", "ok");
        renderMessages({ warns: [], errors: [] });
      } catch (e) {
        setStatus("JSON ungültig", "error");
        renderMessages({ warns: [], errors: [String(e.message || e)] });
      }
    }

    // -----------------------------
    // Render Ablauf
    // -----------------------------
    function calculateAndRender() {
      const { input, problems } = readInput();

      if (problems.length) {
        setStatus(problems[0], "error");
        renderMessages({ warns: [], errors: problems });
        return;
      }

      const check = plausibilityCheck(input);
      if (check.errors.length) {
        setStatus(check.errors[0], "error");
        renderMessages(check);
        return;
      }

      // Plan berechnen (Demo)
      const plan = computeWindingPlan(input);

      // Tabellen A+B
      renderCoilTable(plan.coils, safeStr($("turns").value), safeStr($("wire").value));
      const slots = buildSlotsFromCoils(input.z, plan.coils);
      renderSlotTable(input.z, slots);

      // Nut-Füllplan + Einlegefolge
      const fill = buildFillPlanFromCoils(input.z, plan.coils, input.layersPerSlot);
      renderFillPlanTable(input.z, fill);
      $("sequence").textContent = buildInsertSequence(input.z, fill, input.workMode);

      // Klemmenplan + Kopfblatt
      $("terminalPlan").textContent = buildTerminalPlanText(input);
      $("headerSheet").textContent = buildHeaderSheetText(input);

      // Status + Meldungen
      if (check.warns.length) {
        setStatus(check.warns[0], "warn");
        renderMessages(check);
      } else {
        setStatus(`Plan angezeigt (Z=${input.z}, ${input.poles}-pol, y=${input.y})`, "ok");
        renderMessages({ warns: [], errors: [] });
      }
    }

    // -----------------------------
    // Events
    // -----------------------------
    $("btnDemo").addEventListener("click", applyDemo);
    $("btnCalc").addEventListener("click", calculateAndRender);
    $("btnPrint").addEventListener("click", () => window.print());
    $("btnClear").addEventListener("click", clearAll);

    $("btnExportJson").addEventListener("click", exportJsonToArea);
    $("btnCopyJson").addEventListener("click", copyJson);
    $("btnImportJson").addEventListener("click", importJsonFromArea);

    // Startzustand
    setStatus("bereit", "ok");
  </script>
</body>
</html>
