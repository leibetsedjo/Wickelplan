<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wickelplan (Werkstatt) – Real</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#f6f7f9;
      --text:#111;
      --muted:#666;
      --border:#d9dde3;
      --accent:#0b5fff;
      --accent2:#0a4ed1;
      --ok:#0a7a2f;
      --warn:#b45309;
      --err:#b42318;
      --shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:var(--bg); }
    header{
      padding:16px 14px 10px 14px;
      border-bottom:1px solid var(--border);
      position:sticky; top:0;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(6px);
      z-index:10;
    }
    header h1{ margin:0; font-size:18px; font-weight:800; }
    header p{ margin:6px 0 0 0; font-size:13px; color:var(--muted); }

    main{ max-width:1020px; margin:0 auto; padding:14px; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      box-shadow: var(--shadow);
    }
    .card h2{ margin:0 0 10px 0; font-size:15px; }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size:12px; color:var(--muted); }
    .field input, .field select, .field textarea{
      padding:10px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      font-size:14px;
      outline:none;
    }
    .field textarea{ min-height:78px; resize:vertical; }
    .field input:focus, .field select:focus, .field textarea:focus{
      border-color: rgba(11,95,255,.45);
      box-shadow: 0 0 0 3px rgba(11,95,255,.10);
    }
    .span2{ grid-column: 1 / -1; }

    .btnrow{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    button{
      border:0;
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      cursor:pointer;
      background:#fff;
      border:1px solid var(--border);
    }
    button:hover{ border-color:#c3c9d2; }
    .btn-primary{ background:var(--accent); border-color:var(--accent); color:#fff; }
    .btn-primary:hover{ background:var(--accent2); border-color:var(--accent2); }
    .btn-danger{ border-color:#f1b4b4; color:var(--err); }
    .btn-danger:hover{ border-color:#e9a0a0; }

    .status{ margin-top:10px; font-size:13px; color:var(--muted); }
    .status b{ color:var(--text); }

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:12px;
      margin-left:6px;
    }
    .pill.ok{ border-color: rgba(10,122,47,.35); color:var(--ok); }
    .pill.warn{ border-color: rgba(180,83,9,.35); color:var(--warn); }
    .pill.err{ border-color: rgba(180,35,24,.35); color:var(--err); }

    .muted{ color:var(--muted); }
    .tablewrap{
      overflow:auto;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
    }
    table{
      border-collapse:collapse;
      width:100%;
      min-width:680px;
      font-size:13px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      white-space:nowrap;
      vertical-align:top;
    }
    th{
      position:sticky;
      top:0;
      background:#fff;
      z-index:1;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.2px;
    }
    tr:last-child td{ border-bottom:0; }

    .box{
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      padding:10px;
    }
    .box h3{
      margin:0 0 6px 0;
      font-size:13px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .box pre{
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      line-height:1.35;
    }

    .errbox{
      display:none;
      border:1px solid rgba(180,35,24,.35);
      background: rgba(180,35,24,.06);
      border-radius:12px;
      padding:10px;
      margin-top:10px;
    }
    .errbox h3{ margin:0 0 6px 0; font-size:13px; color:var(--err); font-weight:800; }
    .errbox pre{
      margin:0;
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      color:#222;
    }

    details{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    details + details{ margin-top:10px; }
    summary{
      list-style:none;
      cursor:pointer;
      padding:12px;
      background:linear-gradient(180deg,#ffffff,#fbfbfd);
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:800;
    }
    summary::-webkit-details-marker{ display:none; }
    .sum-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .chev{
      width:22px; height:22px;
      border-radius:999px;
      border:1px solid var(--border);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      color:var(--muted);
      flex:0 0 auto;
    }
    details[open] .chev{ transform: rotate(90deg); }
    .sum-title{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sum-hint{ font-size:12px; color:var(--muted); font-weight:600; white-space:nowrap; }
    .panel{ padding:12px; background:#fff; }

    .jsonArea{
      width:100%;
      min-height:120px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
    }

    .nameplate{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .nameplate .field input{ font-size:13px; }

    .tiny{ font-size:12px; color:var(--muted); margin-top:6px; }

    @media (max-width: 520px){
      .form, .nameplate{ grid-template-columns: 1fr; }
      .span2{ grid-column: auto; }
    }

    @media print{
      header, .no-print { display:none !important; }
      body{ background:#fff; }
      main{ max-width:none; padding:0; }
      .card{ border:0; background:#fff; padding:0; box-shadow:none; }
      details{ border:0; }
      summary{ border:0; padding:0 0 8px 0; background:#fff; }
      .panel{ padding:0; }
      .tablewrap{ border:0; }
      th{ position:static; }
      table{ min-width:0; }
      .box{ border:0; padding:0; }
      .errbox{ display:none !important; }
    }
  </style>
</head>

<body>
  <header>
    <h1>Wickelplan – Werkstatt (Real Test)</h1>
    <p>Standardfall-Erkennung: q = Z / (3·Polzahl). q ganzzahlig ⇒ „Standardfall“ (Automatik OK).</p>
  </header>

  <main>
    <div class="grid">

      <!-- Eingabe -->
      <section class="card no-print">
        <h2>Eingabe</h2>

        <div class="form">
          <div class="field">
            <label for="z">Nuten Z</label>
            <input id="z" type="number" min="6" step="1" placeholder="z.B. 36">
          </div>

          <div class="field">
            <label for="poles">Polzahl</label>
            <select id="poles">
              <option value="2">2-pol</option>
              <option value="4" selected>4-pol</option>
              <option value="6">6-pol</option>
              <option value="8">8-pol</option>
              <option value="10">10-pol</option>
              <option value="12">12-pol</option>
            </select>
          </div>

          <div class="field">
            <label for="layers">Schichten (klassisch)</label>
            <select id="layers">
              <option value="1">einschicht</option>
              <option value="2" selected>zweischicht</option>
            </select>
          </div>

          <div class="field">
            <label for="y">Wickelschritt y</label>
            <input id="y" type="number" min="1" step="1" placeholder="z.B. 9">
          </div>

          <div class="field">
            <label for="conn">Schaltung</label>
            <select id="conn">
              <option value="stern" selected>Stern (Y)</option>
              <option value="dreieck">Dreieck (Δ)</option>
            </select>
          </div>

          <div class="field">
            <label for="terminals">Klemmenbild</label>
            <select id="terminals">
              <option value="6" selected>6 Klemmen (U1/V1/W1/U2/V2/W2)</option>
              <option value="3">3 Klemmen (U/V/W)</option>
            </select>
          </div>

          <div class="field">
            <label for="layersPerSlot">Lagen pro Nut</label>
            <select id="layersPerSlot">
              <option value="2" selected>2 Lagen (unten/oben)</option>
              <option value="3">3 Lagen</option>
              <option value="4">4 Lagen</option>
              <option value="5">5 Lagen</option>
              <option value="6">6 Lagen</option>
            </select>
          </div>

          <div class="field">
            <label for="workMode">Arbeitsweise</label>
            <select id="workMode">
              <option value="slotwise" selected>Nutenweise (Nut für Nut)</option>
              <option value="lowerThenUpper">Gruppenweise (erst unten, dann oben)</option>
            </select>
          </div>

          <div class="field">
            <label for="turns">Windungen pro Spule (N)</label>
            <input id="turns" type="number" min="1" step="1" placeholder="z.B. 38">
          </div>

          <div class="field">
            <label for="wire">Draht (z.B. 0,90mm oder 2×0,63mm)</label>
            <input id="wire" type="text" placeholder="z.B. 0,90mm">
          </div>

          <div class="field span2">
            <label for="notes">Notizen (Werkstatt)</label>
            <textarea id="notes" placeholder="z.B. Drehrichtung, Nutisolation, Bandage, Imprägnierung..."></textarea>
          </div>
        </div>

        <div class="btnrow">
          <button id="btnDemo" type="button">Plausibles Beispiel laden</button>
          <button class="btn-primary" id="btnCalc" type="button">Plan anzeigen</button>
          <button id="btnPrint" type="button">Drucken / PDF</button>
          <button class="btn-danger" id="btnClear" type="button">Reset</button>
        </div>

        <div class="status" id="status">Status: <b>bereit</b><span class="pill ok">OK</span></div>
        <div id="messages" class="muted" style="margin-top:8px;"></div>

        <div id="fatalError" class="errbox">
          <h3>Fehler in der App</h3>
          <pre id="fatalErrorText">—</pre>
          <div class="tiny">Tipp: Screenshot machen und mir schicken.</div>
        </div>
      </section>

      <!-- Typenschild + JSON -->
      <section class="card">
        <h2>Datenblöcke (einklappbar)</h2>

        <details open>
          <summary>
            <div class="sum-left">
              <span class="chev">›</span>
              <span class="sum-title">Typenschild / Motordaten (Abtippen)</span>
            </div>
            <span class="sum-hint">kW / V / A / Hz / IP …</span>
          </summary>
          <div class="panel">
            <div class="nameplate">
              <div class="field"><label for="np_manu">Hersteller</label><input id="np_manu" type="text" placeholder="z.B. Siemens"></div>
              <div class="field"><label for="np_type">Typ / Baureihe</label><input id="np_type" type="text" placeholder="z.B. 1LA7 ..."></div>

              <div class="field"><label for="np_serial">Seriennummer</label><input id="np_serial" type="text" placeholder="z.B. SN ..."></div>
              <div class="field"><label for="np_year">Baujahr</label><input id="np_year" type="text" placeholder="z.B. 2018"></div>

              <div class="field"><label for="np_power">Leistung (kW)</label><input id="np_power" type="text" placeholder="z.B. 1,5"></div>
              <div class="field"><label for="np_speed">Drehzahl (rpm)</label><input id="np_speed" type="text" placeholder="z.B. 1420"></div>

              <div class="field"><label for="np_voltage">Spannung (V)</label><input id="np_voltage" type="text" placeholder="z.B. 230/400"></div>
              <div class="field"><label for="np_current">Strom (A)</label><input id="np_current" type="text" placeholder="z.B. 5,2/3,0"></div>

              <div class="field"><label for="np_freq">Frequenz (Hz)</label><input id="np_freq" type="text" placeholder="z.B. 50"></div>
              <div class="field"><label for="np_cosphi">cos φ</label><input id="np_cosphi" type="text" placeholder="z.B. 0,82"></div>

              <div class="field"><label for="np_eff">Wirkungsgrad (η)</label><input id="np_eff" type="text" placeholder="z.B. IE2"></div>
              <div class="field"><label for="np_ip">Schutzart (IP)</label><input id="np_ip" type="text" placeholder="z.B. IP55"></div>

              <div class="field"><label for="np_ins">Isolationsklasse</label><input id="np_ins" type="text" placeholder="z.B. F"></div>
              <div class="field"><label for="np_duty">Betriebsart</label><input id="np_duty" type="text" placeholder="z.B. S1"></div>

              <div class="field"><label for="np_amb">Umgebung</label><input id="np_amb" type="text" placeholder="z.B. 40°C"></div>
              <div class="field"><label for="np_mount">Bauform / Montage</label><input id="np_mount" type="text" placeholder="z.B. B3 / IM B3"></div>

              <div class="field span2"><label for="np_more">Zusatz</label><input id="np_more" type="text" placeholder="z.B. Lager, Normen, Schaltbild..."></div>
            </div>
            <div class="tiny">Diese Daten gehen in JSON & Kopfblatt (PDF).</div>
          </div>
        </details>

        <details>
          <summary>
            <div class="sum-left">
              <span class="chev">›</span>
              <span class="sum-title">JSON Export / Import</span>
            </div>
            <span class="sum-hint">Speichern & Laden</span>
          </summary>
          <div class="panel">
            <div class="btnrow" style="margin-top:0;">
              <button id="btnExportJson" type="button">JSON erzeugen</button>
              <button id="btnCopyJson" type="button">JSON kopieren</button>
              <button id="btnImportJson" type="button">JSON importieren</button>
            </div>
            <div class="tiny">JSON ist dein „Speichern/Laden“ ohne Internet.</div>
            <textarea id="jsonArea" class="jsonArea" placeholder="Export erscheint hier oder JSON zum Import einfügen..."></textarea>
          </div>
        </details>
      </section>

      <!-- Ausgabe -->
      <section class="card">
        <h2>Ausgabe (einklappbar)</h2>

        <details open>
          <summary>
            <div class="sum-left">
              <span class="chev">›</span>
              <span class="sum-title">Klemmenplan / Kopfblatt</span>
            </div>
            <span class="sum-hint">U1/U2…</span>
          </summary>
          <div class="panel">
            <div class="box">
              <h3>Klemmen / U1-U2 / V1-V2 / W1-W2</h3>
              <pre id="terminalPlan" class="muted">Wird beim „Plan anzeigen“ erzeugt.</pre>
            </div>
            <div class="box" style="margin-top:10px;">
              <h3>Kopfblatt (für PDF)</h3>
              <pre id="headerSheet" class="muted">Wird beim „Plan anzeigen“ erzeugt.</pre>
            </div>
          </div>
        </details>

        <details open>
          <summary>
            <div class="sum-left">
              <span class="chev">›</span>
              <span class="sum-title">Tabelle A – Spulenliste (Nut → Nut)</span>
            </div>
            <span class="sum-hint">Real berechnet</span>
          </summary>
          <div class="panel">
            <div class="tablewrap">
              <table id="coilTable" aria-label="Spulenliste">
                <thead>
                  <tr>
                    <th>Spule Nr.</th>
                    <th>Lage</th>
                    <th>Startnut</th>
                    <th>Endnut</th>
                    <th>Phase</th>
                    <th>+/−</th>
                    <th>Gruppe</th>
                    <th>Windungen</th>
                    <th>Draht</th>
                  </tr>
                </thead>
                <tbody id="coilBody">
                  <tr><td colspan="9" class="muted">Noch kein Plan – „Plausibles Beispiel laden“ oder „Plan anzeigen“.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </details>

        <details>
          <summary>
            <div class="sum-left">
              <span class="chev">›</span>
              <span class="sum-title">Tabelle B – Nutenbelegung (oben / unten)</span>
            </div>
            <span class="sum-hint">aus Spulen</span>
          </summary>
          <div class="panel">
            <div class="tablewrap">
              <table id="slotTable" aria-label="Nutenbelegung">
                <thead>
                  <tr>
                    <th>Nut</th>
                    <th>oben</th>
                    <th>unten</th>
                  </tr>
                </thead>
                <tbody id="slotBody">
                  <tr><td colspan="3" class="muted">Wird automatisch aus der Spulenliste erzeugt.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </details>

        <details open>
          <summary>
            <div class="sum-left">
              <span class="chev">›</span>
              <span class="sum-title">Tabelle C – Nut-Füllplan (Lagen)</span>
            </div>
            <span class="sum-hint">für „Träufeln“</span>
          </summary>
          <div class="panel">
            <div class="tablewrap">
              <table id="fillTable" aria-label="Nut-Füllplan">
                <thead id="fillHead">
                  <tr><th class="muted">Noch kein Plan</th></tr>
                </thead>
                <tbody id="fillBody">
                  <tr><td class="muted">Wird beim „Plan anzeigen“ erzeugt.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </details>

        <details open>
          <summary>
            <div class="sum-left">
              <span class="chev">›</span>
              <span class="sum-title">Tabelle D – Einlegefolge / Arbeitsfolge</span>
            </div>
            <span class="sum-hint">Rezept</span>
          </summary>
          <div class="panel">
            <div class="box">
              <h3>Einlegefolge</h3>
              <pre id="sequence" class="muted">Wird beim „Plan anzeigen“ erzeugt.</pre>
            </div>
          </div>
        </details>

        <p class="muted" style="margin:10px 0 0 0; font-size:12px;">
          Tipp: Für PDF „Drucken / PDF“ und „Als PDF speichern“.
        </p>
      </section>
    </div>
  </main>

  <script>
    // ---------- Crash-Anzeige ----------
    function showFatalError(err) {
      const box = document.getElementById("fatalError");
      const txt = document.getElementById("fatalErrorText");
      if (!box || !txt) return;
      box.style.display = "block";
      txt.textContent = String(err && err.stack ? err.stack : err);
    }
    window.addEventListener("error", (e) => showFatalError(e.error || e.message || "Unbekannter Fehler"));
    window.addEventListener("unhandledrejection", (e) => showFatalError(e.reason || "Unhandled Promise Rejection"));

    const $ = (id) => document.getElementById(id);

    function setStatus(text, type="ok") {
      let pill = '<span class="pill ok">OK</span>';
      if (type === "warn") pill = '<span class="pill warn">Hinweis</span>';
      if (type === "error") pill = '<span class="pill err">Fehler</span>';
      $("status").innerHTML = `Status: <b>${text}</b>${pill}`;
    }

    function renderMessages(check) {
      const el = $("messages");
      if (!el) return;
      const warns = (check && check.warns) ? check.warns : [];
      const errors = (check && check.errors) ? check.errors : [];
      if (warns.length === 0 && errors.length === 0) { el.innerHTML = ""; return; }
      const items = [];
      for (const w of warns) items.push(`<li>${w}</li>`);
      for (const e of errors) items.push(`<li>${e}</li>`);
      el.innerHTML = `<ul style="margin:6px 0 0 18px; padding:0;">${items.join("")}</ul>`;
    }

    function normalizeNut(n, z) {
      let x = n % z;
      if (x === 0) x = z;
      if (x < 0) x += z;
      return x;
    }
    function safeInt(v, fallback=null) {
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : fallback;
    }
    function safeStr(v) { return (v ?? "").toString().trim(); }

    // ---------- Standardfall-Info (q) ----------
    function windingClassInfo(z, poles) {
      const m = 3;
      const denom = m * poles;
      const q = z / denom;
      const isInteger = Number.isFinite(q) && Math.abs(q - Math.round(q)) < 1e-9;
      return { q, denom, isInteger };
    }

    // ---------- Plausibilität + Standardfall-Text ----------
    function plausibilityCheck(input) {
      const issues = { errors: [], warns: [] };
      const { z, poles, layers, y } = input;

      if (!Number.isInteger(z) || z < 6) issues.errors.push("Nuten Z ist ungültig (mind. 6).");
      if (!Number.isInteger(poles) || poles < 2) issues.errors.push("Polzahl ist ungültig.");
      if (!Number.isInteger(y) || y < 1) issues.errors.push("Wickelschritt y ist ungültig (mind. 1).");
      if (![1,2].includes(layers)) issues.errors.push("Schichten muss 1 oder 2 sein.");
      if (issues.errors.length) return issues;

      if (y >= z) issues.errors.push("y darf nicht >= Z sein.");

      const fullPitch = z / poles;
      const diff = Math.abs(y - fullPitch);
      if (y > Math.floor(z/2)) issues.warns.push("y ist größer als Z/2 (ungewöhnlich).");
      if (diff > 3) issues.warns.push(`Wickelschritt wirkt unplausibel: y=${y}, Vollschritt≈${fullPitch.toFixed(1)}.`);

      if (layers === 2 && z < 12) issues.warns.push("Zweischicht mit sehr kleiner Nutenzahl ist ungewöhnlich.");
      if (z % 3 !== 0) issues.warns.push("Z ist nicht durch 3 teilbar (bei 3-phasig oft unüblich).");

      const info = windingClassInfo(z, poles);
      if (info.isInteger) {
        issues.warns.push(`Standardfall ✅: q = ${z}/(${info.denom}) = ${info.q.toFixed(3)} → ganzzahlig (${Math.round(info.q)}). Automatik geeignet.`);
      } else {
        issues.errors.push(`Sonderfall ❌: q = ${z}/(${info.denom}) = ${info.q.toFixed(3)} → NICHT ganzzahlig. Real-Automatik nicht sicher.`);
      }

      if (layers !== 2) issues.warns.push("Hinweis: Real-Generator ist für zweischicht optimiert. Einschicht kann abweichen.");

      return issues;
    }

    // ---------- REAL: Spulenliste berechnen (Standardfall) ----------
    function buildRealCoils(input) {
      const { z, poles, y } = input;

      const info = windingClassInfo(z, poles);
      if (!info.isInteger) {
        throw new Error("Sonderfall: q nicht ganzzahlig – Real-Berechnung abgebrochen.");
      }

      const slotPitchElec = (180 * poles) / z; // Grad elektrisch pro Nut

      const phases = [
        { name: "U", axis: 0 },
        { name: "V", axis: -120 },
        { name: "W", axis: 120 }
      ];

      function phaseForSlot(slot) {
        const theta = (slot - 1) * slotPitchElec;
        let best = null;
        for (const ph of phases) {
          const rad = (Math.PI / 180) * (theta - ph.axis);
          const val = Math.sin(rad);
          const abs = Math.abs(val);
          if (!best || abs > best.abs) best = { phase: ph.name, sign: val >= 0 ? "+" : "-", abs };
        }
        return best;
      }

      function groupForSlot(slot, phaseName) {
        const theta = (slot - 1) * slotPitchElec;
        const poleBand = Math.floor(theta / 180) + 1; // 1..poles
        const phaseIndex = phaseName === "U" ? 0 : phaseName === "V" ? 1 : 2;
        return (poleBand - 1) * 3 + (phaseIndex + 1);
      }

      const coils = [];
      const coilCount = Math.floor(z / 2);

      for (let i = 1; i <= coilCount; i++) {
        const startNut = i;
        const endNut = normalizeNut(i + y, z);
        const ph = phaseForSlot(startNut);

        coils.push({
          nr: i,
          lage: "oben→unten",
          startNut,
          endNut,
          phase: ph.phase,
          sign: ph.sign,
          gruppe: groupForSlot(startNut, ph.phase)
        });
      }
      return coils;
    }

    function computeWindingPlan(input) {
      return { coils: buildRealCoils(input) };
    }

    // ---------- U1/U2 V1/V2 W1/W2 Ableitung ----------
    // Regel:
    // - sortiert je Phase nach gruppe, dann nr
    // - bei sign "+" : start = startNut oben, end = endNut unten
    // - bei sign "-" : start = endNut unten, end = startNut oben
    function coilOrientation(c) {
      if (c.sign === "+") {
        return {
          start: { nut: c.startNut, pos: "oben", tag: `Spule ${c.nr} (A)` },
          end:   { nut: c.endNut,   pos: "unten", tag: `Spule ${c.nr} (B)` }
        };
      }
      return {
        start: { nut: c.endNut,   pos: "unten", tag: `Spule ${c.nr} (B)` },
        end:   { nut: c.startNut, pos: "oben",  tag: `Spule ${c.nr} (A)` }
      };
    }

    function buildTerminalEndpoints(coils) {
      const phases = ["U","V","W"];
      const map = {};
      for (const ph of phases) {
        const list = coils
          .filter(c => c.phase === ph)
          .slice()
          .sort((a,b) => (a.gruppe - b.gruppe) || (a.nr - b.nr));

        if (list.length === 0) { map[ph] = null; continue; }

        const first = coilOrientation(list[0]).start;
        const last  = coilOrientation(list[list.length - 1]).end;

        // interconnect list (Ende -> Start) als Hilfe
        const joins = [];
        for (let i=0;i<list.length-1;i++){
          const aEnd = coilOrientation(list[i]).end;
          const bStart = coilOrientation(list[i+1]).start;
          joins.push(`${ph}: ${aEnd.nut} ${aEnd.pos}  →  ${bStart.nut} ${bStart.pos}`);
        }

        map[ph] = {
          start: first, end: last,
          orderCount: list.length,
          joins
        };
      }
      return map;
    }

    function buildKlemmenText(input, coils) {
      const ends = buildTerminalEndpoints(coils);
      const conn = input.conn;
      const terminals = String(input.terminals);

      function fmtPoint(p){ return `Nut ${p.nut} ${p.pos}`; }

      const lines = [];
      lines.push(`Regel (App): pro Phase nach Gruppe/Spule sortiert; "+" => Start oben, "-" => Start unten.`);
      lines.push("");

      if (terminals === "3") {
        lines.push(`Klemmenbild: 3 Klemmen (U/V/W)`);
        lines.push(`Hinweis: Verschaltung meist intern fix (Stern oder Δ intern).`);
        lines.push("");
        lines.push(`U = ${ends.U ? fmtPoint(ends.U.start) : "—"}  …  ${ends.U ? fmtPoint(ends.U.end) : "—"}`);
        lines.push(`V = ${ends.V ? fmtPoint(ends.V.start) : "—"}  …  ${ends.V ? fmtPoint(ends.V.end) : "—"}`);
        lines.push(`W = ${ends.W ? fmtPoint(ends.W.start) : "—"}  …  ${ends.W ? fmtPoint(ends.W.end) : "—"}`);
        return lines.join("\n");
      }

      // 6 Klemmen
      lines.push(`Klemmenbild: 6 Klemmen (U1/V1/W1/U2/V2/W2)`);
      lines.push("");
      lines.push(`U1 = ${ends.U ? fmtPoint(ends.U.start) : "—"}`);
      lines.push(`U2 = ${ends.U ? fmtPoint(ends.U.end)   : "—"}`);
      lines.push(`V1 = ${ends.V ? fmtPoint(ends.V.start) : "—"}`);
      lines.push(`V2 = ${ends.V ? fmtPoint(ends.V.end)   : "—"}`);
      lines.push(`W1 = ${ends.W ? fmtPoint(ends.W.start) : "—"}`);
      lines.push(`W2 = ${ends.W ? fmtPoint(ends.W.end)   : "—"}`);

      lines.push("");
      if (conn === "stern") {
        lines.push(`Schaltung: Stern (Y)`);
        lines.push(`Brücken: U2 + V2 + W2 zusammen (Sternpunkt)`);
        lines.push(`Einspeisung: L1→U1, L2→V1, L3→W1`);
      } else {
        lines.push(`Schaltung: Dreieck (Δ)`);
        lines.push(`Brücken: U1–W2, V1–U2, W1–V2`);
        lines.push(`Einspeisung: an die drei Brückenpunkte (L1/L2/L3)`);
      }

      lines.push("");
      lines.push(`Interne Serien-Verbindungen (Hilfe):`);
      for (const ph of ["U","V","W"]) {
        if (!ends[ph]) continue;
        lines.push(`- Phase ${ph} (${ends[ph].orderCount} Spulen):`);
        if (ends[ph].joins.length === 0) lines.push(`  (nur 1 Spule – keine Zwischenverbindung)`);
        for (const j of ends[ph].joins) lines.push(`  ${j}`);
      }

      return lines.join("\n");
    }

    // ---------- Tabellen ----------
    function renderCoilTable(coils, turns, wire) {
      const body = $("coilBody");
      body.innerHTML = "";
      if (!coils || coils.length===0){ body.innerHTML = `<tr><td colspan="9" class="muted">Keine Spulen.</td></tr>`; return; }
      for (const c of coils){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.nr}</td><td>${c.lage}</td><td>${c.startNut}</td><td>${c.endNut}</td>
          <td>${c.phase}</td><td>${c.sign}</td><td>${c.gruppe}</td>
          <td>${turns || '<span class="muted">—</span>'}</td>
          <td>${wire || '<span class="muted">—</span>'}</td>`;
        body.appendChild(tr);
      }
    }

    function buildSlotsFromCoils(z, coils){
      const slots = Array.from({length:z+1}, ()=>({oben:"", unten:""}));
      for (const c of coils){
        const obenText = `${c.sign}${c.phase}`;
        const untenText = `${c.sign}${c.phase}`;
        const s = normalizeNut(c.startNut, z);
        const e = normalizeNut(c.endNut, z);
        slots[s].oben = slots[s].oben ? `${slots[s].oben}, ${obenText}` : obenText;
        slots[e].unten = slots[e].unten ? `${slots[e].unten}, ${untenText}` : untenText;
      }
      return slots;
    }
    function renderSlotTable(z, slots){
      const body = $("slotBody"); body.innerHTML="";
      for (let nut=1; nut<=z; nut++){
        const tr = document.createElement("tr");
        const oben = slots[nut]?.oben || "";
        const unten = slots[nut]?.unten || "";
        tr.innerHTML = `<td>${nut}</td><td>${oben || '<span class="muted">—</span>'}</td><td>${unten || '<span class="muted">—</span>'}</td>`;
        body.appendChild(tr);
      }
    }

    // ---------- Nut-Füllplan ----------
    function splitLayers(total){ const top=Math.ceil(total/2); return { topCount: top, bottomCount: total-top }; }
    function makeEmptyFillPlan(z, totalLayers){
      const {topCount,bottomCount} = splitLayers(totalLayers);
      const plan = Array.from({length:z+1}, ()=>({
        bottom: Array.from({length:bottomCount}, ()=>""),
        top: Array.from({length:topCount}, ()=>"")
      }));
      return { plan, topCount, bottomCount };
    }
    function formatConductor(c, sideLabel){ return `${c.sign}${c.phase}#${c.nr}${sideLabel}`; }
    function placeInFirstFree(arr, text){
      for (let i=0;i<arr.length;i++){ if(!arr[i]){ arr[i]=text; return; } }
      if(arr.length===0) return;
      arr[arr.length-1] = arr[arr.length-1] ? `${arr[arr.length-1]}, ${text}` : text;
    }
    function buildFillPlanFromCoils(z, coils, totalLayers){
      const { plan, topCount, bottomCount } = makeEmptyFillPlan(z, totalLayers);
      for (const c of coils){
        const s = normalizeNut(c.startNut, z);
        const e = normalizeNut(c.endNut, z);
        const tA = formatConductor(c,"A");
        const tB = formatConductor(c,"B");
        if (topCount>0) placeInFirstFree(plan[s].top, tA);
        if (bottomCount>0) placeInFirstFree(plan[e].bottom, tB);
        else if (topCount>0) placeInFirstFree(plan[e].top, tB);
      }
      return { plan, topCount, bottomCount };
    }
    function renderFillPlanTable(z, fill){
      const head = $("fillHead"), body = $("fillBody");
      head.innerHTML=""; body.innerHTML="";
      const { topCount, bottomCount, plan } = fill;
      const trh = document.createElement("tr");
      trh.innerHTML = `<th>Nut</th>` +
        Array.from({length:bottomCount},(_,i)=>`<th>unten L${i+1}</th>`).join("") +
        Array.from({length:topCount},(_,i)=>`<th>oben L${i+1}</th>`).join("");
      head.appendChild(trh);

      for (let slot=1; slot<=z; slot++){
        const tr = document.createElement("tr");
        let html = `<td>${slot}</td>`;
        for (let i=0;i<bottomCount;i++){
          const v = plan[slot].bottom[i] || "";
          html += `<td>${v || '<span class="muted">—</span>'}</td>`;
        }
        for (let i=0;i<topCount;i++){
          const v = plan[slot].top[i] || "";
          html += `<td>${v || '<span class="muted">—</span>'}</td>`;
        }
        tr.innerHTML = html; body.appendChild(tr);
      }
      const min = 240 + (bottomCount+topCount)*180;
      $("fillTable").style.minWidth = `${Math.max(680, min)}px`;
    }

    function buildInsertSequence(z, fill, workMode){
      const { topCount, bottomCount, plan } = fill;
      const steps = [];
      const pushStep = (slot, side, li, content) => steps.push(`• Nut ${slot} ${side} L${li+1}: ${content}`);

      if (workMode === "lowerThenUpper"){
        for (let li=0; li<bottomCount; li++){
          for (let slot=1; slot<=z; slot++){
            const c = plan[slot].bottom[li]; if(c) pushStep(slot,"unten",li,c);
          }
        }
        for (let li=0; li<topCount; li++){
          for (let slot=1; slot<=z; slot++){
            const c = plan[slot].top[li]; if(c) pushStep(slot,"oben",li,c);
          }
        }
      } else {
        for (let slot=1; slot<=z; slot++){
          for (let li=0; li<bottomCount; li++){
            const c = plan[slot].bottom[li]; if(c) pushStep(slot,"unten",li,c);
          }
          for (let li=0; li<topCount; li++){
            const c = plan[slot].top[li]; if(c) pushStep(slot,"oben",li,c);
          }
        }
      }

      if (!steps.length) return "Keine Einlegefolge (noch keine Leiter im Plan).";
      steps.push("", "— Abschluss (Werkstatt) —",
        "• Nutkeile setzen / sichern",
        "• Bandagieren / Verschnüren (falls üblich)",
        "• Träufeln/Imprägnieren + Aushärtung (falls üblich)",
        "• Isolationsmessung / Widerstände je Phase prüfen"
      );
      return steps.join("\n");
    }

    // ---------- Nameplate ----------
    const NAMEPLATE_IDS = ["np_manu","np_type","np_serial","np_year","np_power","np_speed","np_voltage","np_current","np_freq","np_cosphi","np_eff","np_ip","np_ins","np_duty","np_amb","np_mount","np_more"];
    function readNameplate(){ const out={}; for(const id of NAMEPLATE_IDS) out[id]=safeStr($(id).value); return out; }
    function applyNameplate(npObj){ for (const id of NAMEPLATE_IDS) $(id).value = (npObj && (id in npObj)) ? (npObj[id] ?? "") : ""; }

    function buildHeaderSheetText(input){
      const turns = safeStr($("turns").value);
      const wire = safeStr($("wire").value);
      const notes = safeStr($("notes").value);
      const np = readNameplate();
      const info = windingClassInfo(input.z, input.poles);
      const qText = `q=${info.q.toFixed(3)} (${info.isInteger ? "Standardfall" : "Sonderfall"})`;

      return [
        `— Kopfblatt (Werkstatt) —`,
        `Z=${input.z} | ${input.poles}-pol | Schichten=${input.layers} | y=${input.y} | ${qText}`,
        `Schaltung=${input.conn} | Klemmen=${input.terminals} | Lagen/Nut=${input.layersPerSlot} | Arbeitsweise=${input.workMode}`,
        ``,
        `Wickeldaten: Windungen/Spule=${turns || "—"} | Draht=${wire || "—"}`,
        ``,
        `Typenschild: Hersteller=${np.np_manu || "—"} | Typ=${np.np_type || "—"} | SN=${np.np_serial || "—"} | Bj=${np.np_year || "—"}`,
        `kW=${np.np_power || "—"} | rpm=${np.np_speed || "—"} | V=${np.np_voltage || "—"} | A=${np.np_current || "—"} | Hz=${np.np_freq || "—"}`,
        `cosφ=${np.np_cosphi || "—"} | η=${np.np_eff || "—"} | IP=${np.np_ip || "—"} | Isokl.=${np.np_ins || "—"} | S=${np.np_duty || "—"}`,
        `Umgebung=${np.np_amb || "—"} | Bauform=${np.np_mount || "—"} | Zusatz=${np.np_more || "—"}`,
        ``,
        `Notizen:`,
        `${notes || "—"}`
      ].join("\n");
    }

    // ---------- Input ----------
    function readInput(){
      const z = safeInt($("z").value, null);
      const poles = safeInt($("poles").value, 4);
      const layers = safeInt($("layers").value, 2);
      const y = safeInt($("y").value, null);
      const conn = $("conn").value;

      const terminals = safeInt($("terminals").value, 6);
      const layersPerSlot = safeInt($("layersPerSlot").value, 2);
      const workMode = $("workMode").value;

      const turns = safeInt($("turns").value, null);
      const wire = safeStr($("wire").value);
      const notes = safeStr($("notes").value);

      const problems = [];
      if (!z || z < 6) problems.push("Z (Nuten) fehlt oder ist zu klein.");
      if (!y || y < 1) problems.push("Wickelschritt y fehlt oder ist ungültig.");
      if (![1,2].includes(layers)) problems.push("Schichten muss 1 oder 2 sein.");
      if (!layersPerSlot || layersPerSlot < 2) problems.push("Lagen pro Nut muss mind. 2 sein.");

      return { input:{ z,poles,layers,y,conn,terminals,layersPerSlot,workMode,turns,wire,notes }, problems };
    }

    // ---------- JSON ----------
    function buildStateObject(){
      const { input } = readInput();
      return { version:1, timestamp:new Date().toISOString(), input:{...input}, nameplate: readNameplate() };
    }
    function applyStateObject(state){
      if (!state || !state.input) throw new Error("JSON hat kein Feld 'input'.");
      const i = state.input;
      $("z").value = i.z ?? "";
      $("poles").value = String(i.poles ?? "4");
      $("layers").value = String(i.layers ?? "2");
      $("y").value = i.y ?? "";
      $("conn").value = i.conn ?? "stern";
      $("terminals").value = String(i.terminals ?? "6");
      $("layersPerSlot").value = String(i.layersPerSlot ?? "2");
      $("workMode").value = i.workMode ?? "slotwise";
      $("turns").value = i.turns ?? "";
      $("wire").value = i.wire ?? "";
      $("notes").value = i.notes ?? "";
      applyNameplate(state.nameplate || {});
    }
    function exportJsonToArea(){
      $("jsonArea").value = JSON.stringify(buildStateObject(), null, 2);
      setStatus("JSON erzeugt", "ok");
    }
    async function copyJson(){
      const txt = $("jsonArea").value.trim();
      if (!txt){ setStatus("Kein JSON zum Kopieren vorhanden", "warn"); return; }
      try{ await navigator.clipboard.writeText(txt); setStatus("JSON kopiert", "ok"); }
      catch(e){ $("jsonArea").focus(); $("jsonArea").select(); setStatus("Kopieren blockiert – Text markiert (CMD+C)", "warn"); }
    }
    function importJsonFromArea(){
      const txt = $("jsonArea").value.trim();
      if (!txt){ setStatus("Bitte JSON einfügen", "warn"); return; }
      try{
        const obj = JSON.parse(txt);
        applyStateObject(obj);
        setStatus("JSON importiert", "ok");
        renderMessages({warns:[], errors:[]});
      } catch(e){
        setStatus("JSON ungültig", "error");
        renderMessages({warns:[], errors:[String(e.message || e)]});
      }
    }

    // ---------- Demo ----------
    function buildDemoInput() {
      return { z: 36, poles: 4, layers: 2, y: 9, conn: "stern", terminals: 6, layersPerSlot: 2, workMode: "slotwise", turns: 38, wire: "0,90mm", notes: "Nut 1 oben markiert, Blick Antriebsseite." };
    }
    function buildDemoNameplate() {
      return { np_manu:"Beispiel", np_type:"IEC Motor", np_serial:"—", np_year:"—", np_power:"1,5", np_speed:"1420", np_voltage:"230/400", np_current:"5,2/3,0", np_freq:"50", np_cosphi:"0,82", np_eff:"IE2", np_ip:"IP55", np_ins:"F", np_duty:"S1", np_amb:"40°C", np_mount:"B3 / IM B3", np_more:"—" };
    }
    function applyDemo(){
      const d = buildDemoInput();
      $("z").value=d.z; $("poles").value=String(d.poles); $("layers").value=String(d.layers); $("y").value=d.y;
      $("conn").value=d.conn; $("terminals").value=String(d.terminals); $("layersPerSlot").value=String(d.layersPerSlot); $("workMode").value=d.workMode;
      $("turns").value=d.turns; $("wire").value=d.wire; $("notes").value=d.notes;
      applyNameplate(buildDemoNameplate());
      setStatus("Plausibles Beispiel geladen", "ok");
      renderMessages({warns:[], errors:[]});
    }

    function clearAll(){
      $("z").value=""; $("y").value=""; $("poles").value="4"; $("layers").value="2"; $("conn").value="stern";
      $("terminals").value="6"; $("layersPerSlot").value="2"; $("workMode").value="slotwise";
      $("turns").value=""; $("wire").value=""; $("notes").value="";
      applyNameplate({});

      $("coilBody").innerHTML = `<tr><td colspan="9" class="muted">Noch kein Plan – „Plausibles Beispiel laden“ oder „Plan anzeigen“.</td></tr>`;
      $("slotBody").innerHTML = `<tr><td colspan="3" class="muted">Wird automatisch aus der Spulenliste erzeugt.</td></tr>`;
      $("fillHead").innerHTML = `<tr><th class="muted">Noch kein Plan</th></tr>`;
      $("fillBody").innerHTML = `<tr><td class="muted">Wird beim „Plan anzeigen“ erzeugt.</td></tr>`;
      $("sequence").textContent = "Wird beim „Plan anzeigen“ erzeugt.";
      $("terminalPlan").textContent = "Wird beim „Plan anzeigen“ erzeugt.";
      $("headerSheet").textContent = "Wird beim „Plan anzeigen“ erzeugt.";
      $("messages").innerHTML = "";
      setStatus("bereit", "ok");
    }

    function calculateAndRender(){
      const { input, problems } = readInput();
      if (problems.length){
        setStatus(problems[0], "error");
        renderMessages({warns:[], errors:problems});
        return;
      }

      const check = plausibilityCheck(input);
      if (check.errors.length){
        setStatus(check.errors[0], "error");
        renderMessages(check);
        return;
      }

      // echte Berechnung
      let plan;
      try {
        plan = computeWindingPlan(input);
      } catch(e) {
        setStatus("Berechnung abgebrochen", "error");
        renderMessages({ warns: [], errors: [String(e.message || e)] });
        return;
      }

      renderCoilTable(plan.coils, safeStr($("turns").value), safeStr($("wire").value));

      const slots = buildSlotsFromCoils(input.z, plan.coils);
      renderSlotTable(input.z, slots);

      const fill = buildFillPlanFromCoils(input.z, plan.coils, input.layersPerSlot);
      renderFillPlanTable(input.z, fill);
      $("sequence").textContent = buildInsertSequence(input.z, fill, input.workMode);

      // <<< NEU: U1/U2 etc. >>>
      $("terminalPlan").textContent = buildKlemmenText(input, plan.coils);

      $("headerSheet").textContent = buildHeaderSheetText(input);

      if (check.warns.length){
        setStatus(check.warns[0], "warn");
        renderMessages(check);
      } else {
        setStatus(`Plan angezeigt (Z=${input.z}, ${input.poles}-pol, y=${input.y})`, "ok");
        renderMessages({warns:[], errors:[]});
      }
    }

    // Events
    $("btnDemo").addEventListener("click", applyDemo);
    $("btnCalc").addEventListener("click", calculateAndRender);
    $("btnPrint").addEventListener("click", () => window.print());
    $("btnClear").addEventListener("click", clearAll);

    $("btnExportJson").addEventListener("click", exportJsonToArea);
    $("btnCopyJson").addEventListener("click", copyJson);
    $("btnImportJson").addEventListener("click", importJsonFromArea);

    setStatus("bereit", "ok");
  </script>
</body>
</html>
